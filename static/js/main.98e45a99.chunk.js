(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{128:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),o=a(25),i=a.n(o),l=a(1),s=a(2),c=a(14),u=a(5),d=a(6),m=a(58),h=a(21),p=a(12),g=function(){return r.a.createElement("div",null,r.a.createElement("h2",null,"Page under construction --- our ingeneous engineers are working on it"),r.a.createElement("img",{title:"Our oompa loompa is processing. Please wait.",src:a(45),alt:"loading...",align:"middle"}))};var f=function(){return r.a.createElement("div",null,r.a.createElement("h2",null,"Page under construction --- our ingeneous engineers are working on it"),r.a.createElement("img",{title:"Our oompa loompa is processing. Please wait.",src:a(45),alt:"loading...",align:"middle"}))},v=a(11),E=a(29),b=a(10),y=a(31),w=a(131),C=a(7),O=a(53),j=a(68),k=function(e){var t=Object(n.useState)({height:.8*window.innerHeight}),a=Object(v.a)(t,2),o=a[0],i=a[1],l=r.a.useRef([]);Object(n.useEffect)(function(){function e(){i({height:.8*window.innerHeight})}return window.addEventListener("resize",e),e(),function(){return window.removeEventListener("resize",e)}},[]);var s=function(e){for(var t=Object(n.useRef)(),a=Object(n.useRef)(),o=e.mesh,i=e.radius,l=new C.Geometry,s=0;s<o.V.length;s++)l.vertices.push(Object(E.a)(C.Vector3,Object(b.a)(o.Varray[s])));for(var c=0;c<o.E.length;c++){l.faces.push(Object(E.a)(C.Face3,Object(b.a)(o.E[c])));for(var u=0;u<3;u++){var d,m=o.E[c][u];d=o.dA[m]<o.dP[m]&&o.dA[m]<o.dT[m]?new C.Color(1017121):o.dT[m]<o.dP[m]?new C.Color(1000069):new C.Color(8722447),l.faces[c].vertexColors[u]=d}}l.computeBoundingSphere(),l.center(),i.current=l.boundingSphere.radius;var h=new C.MeshStandardMaterial({vertexColors:C.VertexColors}),p=new C.WireframeGeometry(l),g=new C.LineBasicMaterial({color:0,linewidth:5,polygonOffset:!0,polygonOffsetFactor:2,polygonOffsetUnits:1});return l.computeFaceNormals(),r.a.createElement("group",null,r.a.createElement("mesh",{ref:t,geometry:l,material:h}),r.a.createElement("lineSegments",{ref:a,geometry:p,material:g}))}({mesh:e.mesh,radius:l});return r.a.createElement(y.a,{style:{height:o.height,width:"95%",textAlign:"center",background:"#D3D3D3"},camera:{position:[0,0,-3*l.current],far:5*l.current}},r.a.createElement("ambientLight",null),r.a.createElement(n.Suspense,{fallback:null},s),r.a.createElement(w.a,{rotateSpeed:4}))},x=function(e){var t=Object(n.useState)(),a=Object(v.a)(t,2),o=a[0],i=a[1],l=Object(n.useState)(),s=Object(v.a)(l,2),c=s[0],u=s[1],d=e.patientsComputed.map(function(e,t){return{value:t,label:e[0]}});return r.a.createElement("div",{align:"middle"},r.a.createElement(j.a,{split:"vertical",minSize:100,defaultSize:200,primary:"first"},r.a.createElement("div",null,r.a.createElement("h3",null," Select patient"),r.a.createElement(O.a,{options:d,onChange:function(e){i(e.value),console.log(o,e)}}),r.a.createElement("h3",null," Select phase"),r.a.createElement(O.a,{className:"basic-single",classNamePrefix:"select",options:[{value:"ED",label:"End-diastole"},{value:"ES",label:"End-systole"}],onChange:function(e){u(e.value),console.log(c,e)}}),r.a.createElement("h2",null," Measurements "),void 0!==o?r.a.createElement("table",null,r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,"RVOT EDV "),"  ",(e.patientsComputed[o][1]/1e3).toFixed(1)),r.a.createElement("tr",null,r.a.createElement("td",null,"Inlet EDV"),"  ",(e.patientsComputed[o][2]/1e3).toFixed(1)),r.a.createElement("tr",null,r.a.createElement("td",null,"Apical EDV")," ",(e.patientsComputed[o][3]/1e3).toFixed(1)),r.a.createElement("tr",null,r.a.createElement("td",null,"RVOT EF "),"   ",e.patientsComputed[o][4].toFixed(1)),r.a.createElement("tr",null,r.a.createElement("td",null,"Inlet EF"),"   ",e.patientsComputed[o][5].toFixed(1)),r.a.createElement("tr",null,r.a.createElement("td",null,"Apical EF"),"  ",e.patientsComputed[o][6].toFixed(1)))):r.a.createElement("div",null," Select a patient for displaying here the measurements")),void 0!==o&&void 0!==c?r.a.createElement(k,{mesh:e.patientsComputed[o]["ED"===c?7:8]}):r.a.createElement("div",null," No patient selected to display. ")))},D=function(){return r.a.createElement("div",null,r.a.createElement("h2",null,"Page under construction --- our ingeneous engineers are working on it"),r.a.createElement("img",{title:"Our oompa loompa is processing. Please wait.",src:a(45),alt:"loading...",class:"center"}))},V=(a(44),a(73)),S=function(e){return r.a.createElement(V.slide,e,r.a.createElement(h.b,{to:"/"},"Home"),r.a.createElement(h.b,{to:"/computation"},"Computation"),r.a.createElement(h.b,{to:"/visualisation"},"Visualisation"),r.a.createElement(h.b,{to:"/settings"},"Settings"),r.a.createElement(h.b,{to:"/about"},"About"))},F=function(e){Object(u.a)(a,e);var t=Object(d.a)(a);function a(e){var n;return Object(l.a)(this,a),(n=t.call(this,e)).state={patientResults:[],mode:"local"},n.addNewResult=n.addNewResult.bind(Object(c.a)(n)),n.getComputedData=n.getComputedData.bind(Object(c.a)(n)),n}return Object(s.a)(a,[{key:"addNewResult",value:function(e,t,a,n,r,o){var i;i=o?function(e,t){return t}:function(e,t){return 100*(e-t)/e};var l=this.state.patientResults;l.push([e,t[0],t[1],t[2],i(t[0],a[0]),i(t[1],a[1]),i(t[2],a[2]),n,r]),this.setState({patientResults:l})}},{key:"getComputedData",value:function(){return this.state.patientResults}},{key:"render",value:function(){return r.a.createElement("div",{className:"App"},r.a.createElement("header",{className:"App-header"},"Right ventricle parcellation"),r.a.createElement("body",null,r.a.createElement(h.a,{basename:"/"},r.a.createElement(S,{pageWrapId:"page-wrap",outerContainerId:"App"}),r.a.createElement("div",{id:"page-wrap"},r.a.createElement(p.c,null,r.a.createElement(p.a,{exact:!0,path:["/","/home"]},r.a.createElement(g,null)),r.a.createElement(p.a,{path:"/computation"},r.a.createElement(m.a,{addNewResult:this.addNewResult,patientsComputed:this.state.patientResults})),r.a.createElement(p.a,{path:"/about"},r.a.createElement(D,null)),r.a.createElement(p.a,{path:"/visualisation"},r.a.createElement(x,{patientsComputed:this.state.patientResults})),r.a.createElement(p.a,{path:"/settings"},r.a.createElement(f,null)))))))}}]),a}(r.a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(F,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},32:function(e,t,a){"use strict";var n=a(9),r=a(1),o=a(2);var i=function(){function e(t){Object(r.a)(this,e),this.acumWeights=[],this.totalWeight=0;for(var a=0;a<t.length;a++)this.acumWeights.push(this.totalWeight),this.totalWeight+=t[a]}return Object(o.a)(e,[{key:"getSample",value:function(){return function e(t,a,n,r){var o=Math.floor((n+r)/2);return a[n]<=t&&(n+1===a.length||a[n+1]>=t)?n:a[o]<t?e(t,a,o,r):e(t,a,n,o)}(Math.random()*this.totalWeight,this.acumWeights,0,this.acumWeights.length)}}]),e}(),l=function(){function e(t,a){Object(r.a)(this,e),this.triangles=a,this.coordinates=t,this.mean=new n.d(0,0,0);for(var o=0;o<this.coordinates.length;o++)this.mean.addScaledVector(this.coordinates[o],1/this.coordinates.length);this.absoluteVolumes=[],this.signedVolumes=[];for(var l=0,s=0;s<this.triangles.length;s++){var c=new n.b,u=this.triangles[s];c.set(this.coordinates[u[0]].x-this.mean.x,this.coordinates[u[0]].y-this.mean.y,this.coordinates[u[0]].z-this.mean.z,this.coordinates[u[1]].x-this.mean.x,this.coordinates[u[1]].y-this.mean.y,this.coordinates[u[1]].z-this.mean.z,this.coordinates[u[2]].x-this.mean.x,this.coordinates[u[2]].y-this.mean.y,this.coordinates[u[2]].z-this.mean.z);var d=c.determinant()/6;l+=d,this.absoluteVolumes.push(Math.abs(d)),this.signedVolumes.push(d),this.totalVol=l}console.log(l),this.sampler=new i(this.absoluteVolumes)}return Object(o.a)(e,[{key:"getSample",value:function(){var e=this.sampler.getSample(),t=-Math.log(Math.random()),a=-Math.log(Math.random()),r=-Math.log(Math.random()),o=-Math.log(Math.random()),i=t+a+r+o;t/=i,a/=i,r/=i,o/=i;var l=new n.d(0,0,0),s=this.triangles[e];return l.addScaledVector(this.coordinates[s[0]],t).addScaledVector(this.coordinates[s[1]],a).addScaledVector(this.coordinates[s[2]],r).addScaledVector(this.mean,o),{point:l,sign:Math.sign(this.signedVolumes[e])}}}]),e}(),s=a(66);a.d(t,"c",function(){return p}),a.d(t,"b",function(){return g}),a.d(t,"a",function(){return E});var c=!1,u=a(85),d=a(92);function m(e,t,a){for(var n=[],r=0;r<a;r++)n.push(Math.min(e[r],t[r]));return n}function h(e,t){for(var a=[],n=0;n<t;n++)a.push(e[n]);return a}function p(e){for(var t=e[1],a=e[0],n=[],r=0;r<a.length;r++)n.push([a[r].x,a[r].y,a[r].z]);for(var o=[388,389,392,393,144,540,145,538,539,422,423,38,541,49,55,328,329,332,333,87,94,100,101,103,104,105,122,123,126,127],i=[410,411,409,408,53,64,65,66,67,68,69,83,476,477,92,478,480,481,482,483,484,485,486,487,488,489,479],l=u(t,n,906),s=u(t,n,o[0]),c=1;c<o.length;c++)s=m(s,u(t,n,o[c]),a.length);for(var d=u(t,n,i[0]),p=1;p<i.length;p++)d=m(d,u(t,n,i[p]),a.length);var g={};return g.E=t,g.V=a,g.Varray=n,g.dA=h(l,a.length),g.dP=h(d,a.length),g.dT=h(s,a.length),g}function g(e,t){var a={};a.E=e[1],a.V=e[0];for(var n=[],r=0;r<a.V.length;r++)n.push([a.V[r].x,a.V[r].y,a.V[r].z]);return a.Varray=n,a.dA=t.dA,a.dP=t.dP,a.dT=t.dT,a}var f="rbf",v=function(e){return e[0].map(function(t,a){return e.map(function(e){return e[a]})})};function E(e){var t,a=Date.now(),r=new l(e.V,e.E);t=void 0===e.nsamples?1e3:e.nsamples;var o=0,i=0,u=0,m=function(e){for(var t=new n.d(1e3,1e4,1e3),a=new n.d(-1e3,-1e4,-1e3),r=0;r<e.length;r++)t.x>e[r].x&&(t.x=e[r].x),a.x<e[r].x&&(a.x=e[r].x),t.y>e[r].y&&(t.y=e[r].y),a.y<e[r].y&&(a.y=e[r].y),t.z>e[r].z&&(t.z=e[r].z),a.z<e[r].z&&(a.z=e[r].z);return[t,a]}(e.V),h=new s.a(m[0],m[1]);if("nearest"===f)for(var p=0;p<e.V.length;p++)h.insert(e.V[p],p);var g,E=Date.now();console.log(E-a),"rbf"===f&&(g=d(e.Varray,v([e.dA,e.dP,e.dT]),"linear"));var b=Date.now();console.log("Time construct RBF",b-E);for(var y=0;y<t;y++){var w,C,O,j=r.getSample();if("nearest"===f){var k=h.findNearestPoint(j.point).data;w=e.dA[k],C=e.dP[k],O=e.dT[k]}else{var x=g([j.point.x,j.point.y,j.point.z]);w=x[0],C=x[1],O=x[2],c&&y%100===0&&console.log(w,C,O)}w<O&&w<C?o+=j.sign:O<C?u+=j.sign:i+=j.sign}var D=Date.now();console.log("Time sampling",D-b),console.log("Time total",D-a);var V=r.totalVol;return[i/(o+i+u)*V,u/(o+i+u)*V,o/(o+i+u)*V]}},44:function(e,t,a){},45:function(e,t,a){e.exports=a.p+"static/media/processing.529e8cb8.gif"},48:function(e,t,a){"use strict";a.d(t,"b",function(){return o}),a.d(t,"a",function(){return i});var n=a(9);function r(e){for(var t=[],a=[],r=e.split(/[\r\n]+/g),o=r[0].split(/ +/),i=parseInt(o[0]),l=parseInt(o[1]),s=1,c=0;c<i;c++){var u=r[s].split(" ");t.push(new n.d(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]))),s++}for(var d=0;d<l;d++){var m=r[s].split(/ +/);if("tri"!==m[2])throw console.log(r[s],s,o),"UCD has non-triangle face";a.push([parseInt(m[3]),parseInt(m[4]),parseInt(m[5])]),s++}return[t,a]}function o(e,t){for(var a=new n.d(0,0,0),r=0;r<e.length;r++)a.addScaledVector(e[r],1/e.length);for(var o=0,i=0;i<t.length;i++){var l=new n.b,s=t[i];l.set(e[s[0]].x-a.x,e[s[0]].y-a.y,e[s[0]].z-a.z,e[s[1]].x-a.x,e[s[1]].y-a.y,e[s[1]].z-a.z,e[s[2]].x-a.x,e[s[2]].y-a.y,e[s[2]].z-a.z),o+=l.determinant()/6}return o}function i(e){return function(e){return new Promise(function(t,a){var n=new FileReader;n.onload=function(){t(n.result)},n.readAsText(e)})}(e).then(r)}},58:function(e,t,a){"use strict";(function(e){var n=a(10),r=a(1),o=a(2),i=a(14),l=a(5),s=a(6),c=a(0),u=a.n(c),d=a(75),m=a(59),h=a(65),p=a(48),g=a(32),f=a(67),v=(a(44),a(21)),E=function(t){Object(l.a)(c,t);var a=Object(s.a)(c);function c(e){var t;return Object(r.a)(this,c),(t=a.call(this,e)).state={patientsToCompute:new f.a,numberToCompute:1,numberComputed:1,mode:"local"},t.addFiles=t.addFiles.bind(Object(i.a)(t)),t.sendPatientFile=t.sendPatientFile.bind(Object(i.a)(t)),t.sendAllPatients=t.sendAllPatients.bind(Object(i.a)(t)),t.generateAndDownload=t.generateAndDownload.bind(Object(i.a)(t)),t}return Object(o.a)(c,[{key:"addFiles",value:function(e){var t=this.state.patientsToCompute;console.log(e),e.forEach(function(e){return t.addNewFile(e)}),this.setState({patients:t})}},{key:"sendPatientFile",value:function(t){var a=this,r=Date.now();if(this.state.patientsToCompute.get(t).keys().length===1+Math.max.apply(Math,Object(n.a)(this.state.patientsToCompute.get(t).keys()))){var o=this.state.patientsToCompute.get(t).get(0).name.split(".").pop();if("docker"!==this.state.mode){var i=this,l=[];return this.state.patientsToCompute.get(t).keys().forEach(function(e){return l.push(a.state.patientsToCompute.get(t).get(e))}),void Promise.all(l.map(p.a)).then(function(e){var t=Date.now();console.log("Time parsing files",t-r);for(var a=-1,n=1e20,o=1;o<e.length;o++){var i=Object(p.b)(e[o][0],e[o][1]);n>i&&(a=o,n=i)}console.log("iMin",a);var l={};return l.ED=e[0],l.ES=e[a],console.log("Selecting ES =",Date.now()-t),l}).then(function(e){var a=Object(g.c)(e.ED),n=Object(g.b)(e.ES,a),o=Object(g.a)(a),l=Object(g.a)(n);i.props.addNewResult(t,o,l,a,n,!1);var s=i.state.patientsToCompute;s.removeFile(t),i.setState({patientsToCompute:s,numberComputed:i.state.numberComputed+1}),console.log("Total patient processing time =",Date.now()-r)})}console.log("Sending new patient");var s=new Headers,c=new FormData;c.append("pId",t),c.append("format",o),this.state.patientsToCompute.get(t).keys().forEach(function(e){return c.append(e,a.state.patientsToCompute.get(t).get(e))}),fetch("http://localhost:5000/computePartitionSingleIndividual",{method:"POST",headers:s,mode:"cors",body:c}).then(function(a){a.json().then(function(a){var n=e.state.patientsToCompute;n.removeFile(t),e.setState({patientsToCompute:n,numberComputed:e.state.numberComputed+1}),e.props.addNewResult(t,[a.outflowEDV,a.inletEDV,a.apicalEDV],[a.outflowEF,a.inletEF,a.apicalEF],void 0,void 0,!0)})})}else this.setState({numberComputed:this.state.numberComputed+1})}},{key:"sendAllPatients",value:function(){var e=this;this.setState({numberToCompute:this.state.patientsToCompute.length(),numberComputed:0}),this.state.patientsToCompute.keys().forEach(function(t){return e.sendPatientFile(t)})}},{key:"generateAndDownload",value:function(){var e="data:text/csv;charset=utf-8,",t=["pID","outflowEDV","inletEDV","apicalEDV","outflowEF","inletEF","apicalEF"],a=t.join(";");e+=a+"\r\n",this.props.patientsComputed.forEach(function(a,n){for(var r=new Array(t.length),o=1;o<t.length;o++)r[o]=Number(a[o]).toFixed(3);var i=r.join(";");e+=i+"\r\n"});var n=encodeURI(e),r=document.createElement("a");r.setAttribute("href",n),r.setAttribute("download","regionalVolumes.csv"),document.body.appendChild(r),r.click()}},{key:"render",value:function(){var e=this.state.patientsToCompute,t=this.props.patientsComputed,a=100*this.state.numberComputed/this.state.numberToCompute;return u.a.createElement("div",{className:"Computation"},u.a.createElement("aside",null,this.state.numberComputed===this.state.numberToCompute?u.a.createElement("div",null,u.a.createElement(m.a,{onDrop:this.addFiles}),u.a.createElement(d.a,{variant:"dark",onClick:this.sendAllPatients,style:{fontSize:18}},"Parcellate!  "),u.a.createElement(d.a,{variant:"dark",disabled:this.state.numberComputed!==this.state.numberToCompute,onClick:this.generateAndDownload,style:{fontSize:18}},"Download CSV"),u.a.createElement(v.b,{to:"/visualisation"},u.a.createElement("button",{type:"button",style:{fontSize:18}},"Visualisation"))):u.a.createElement("div",{class:"container"},u.a.createElement(h.a,{value:a,maxValue:100,minValue:0,text:"".concat(this.state.numberComputed,"/").concat(this.state.numberToCompute)})),u.a.createElement("div",{class:"row"},u.a.createElement("div",{class:"column"},u.a.createElement("h4",null,"Patients to compute "),u.a.createElement("ul",null,e.keys().map(function(t){return u.a.createElement("li",{key:t},u.a.createElement("font",{color:e.get(t).keys().length===1+Math.max.apply(Math,Object(n.a)(e.get(t).keys()))?"black":"red"},t,"  -  ",e.get(t).keys().length," / ",1+Math.max.apply(Math,Object(n.a)(e.get(t).keys()))))}))),u.a.createElement("div",{class:"column"},u.a.createElement("h4",null,"Patients computed "),u.a.createElement("ul",null,t.map(function(e){return u.a.createElement("li",{key:e[0]},u.a.createElement("font",{color:"Black"},e[0]))}))))))}}]),c}(u.a.Component);t.a=E}).call(this,a(43))},59:function(e,t,a){"use strict";var n=a(60),r=a(0),o=a.n(r),i=a(74),l=a(62);function s(){var e=Object(n.a)(["\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  padding: 20px;\n  border-width: 2px;\n  border-radius: 2px;\n  border-color: ",";\n  border-style: dashed;\n  background-color: #fafafa;\n  color: #bdbdbd;\n  outline: none;\n  transition: border .24s ease-in-out;\n"]);return s=function(){return e},e}var c=l.a.div(s(),function(e){return function(e){return e.isDragAccept?"#00e676":e.isDragReject?"#ff1744":e.isDragActive?"#2196f3":"#eeeeee"}(e)});t.a=function(e){var t=Object(r.useCallback)(e.onDrop,[]),a=Object(i.a)({onDrop:t,accept:".vtk, .ucd"}),n=a.getRootProps,l=a.getInputProps,s=a.isDragActive,u=a.isDragAccept,d=a.isDragReject;return o.a.createElement("div",{className:"container"},o.a.createElement(c,n({isDragActive:s,isDragAccept:u,isDragReject:d}),o.a.createElement("input",l()),o.a.createElement("p",null,"Drag 'n' drop some UCD files here, or click to select files")))}},67:function(e,t,a){"use strict";a.d(t,"a",function(){return c});var n=a(10),r=a(5),o=a(6),i=a(1),l=a(2),s=function(){function e(){Object(i.a)(this,e),this.data={}}return Object(l.a)(e,[{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0===this.data[e]&&null===t)return this.set(e,t()),this.data[e];if(void 0===this.data[e])throw Object.assign(new Error("{k} not in dictionary"),{code:400});return this.data[e]}},{key:"set",value:function(e,t){this.data[e]=t}},{key:"keys",value:function(){return Object.keys(this.data)}},{key:"length",value:function(){return this.keys().length}}]),e}(),c=function(e){Object(r.a)(a,e);var t=Object(o.a)(a);function a(){return Object(i.a)(this,a),t.apply(this,arguments)}return Object(l.a)(a,[{key:"addNewFile",value:function(e){var t=e.name.split("_"),a=t.slice(0,-1).join("_"),n=parseInt(t[t.length-1].split(".")[0]);a in this.data||this.set(a,new s),this.get(a).set(n,e)}},{key:"removeFile",value:function(e){console.log("Removing",e),console.log(this),delete this.data[e]}},{key:"isOK",value:function(){var e=this;return this.keys().every(function(t){return e.get(t).keys()===Math.max.apply(Math,Object(n.a)(e.get(t).keys()))})}}]),a}(s)},76:function(e,t,a){e.exports=a(128)}},[[76,1,2]]]);
//# sourceMappingURL=main.98e45a99.chunk.js.map